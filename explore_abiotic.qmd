---
title: "Exporing differents abiotic data sources"
author: "Vincent Bellavamce"
date: "01-23-2023"
format: 
  html:
    embed-resources: true
---

```{r}
#| include: false
aoi <- sf::st_read("data/aoi/aoi.gpkg")
```

## Bathymetry

**Mean_bathy.tif** from Beauchesne and **bathymetry.tif** from GEBCO

```{r}
#| include: false

### Mean bathymetry
bathy_mean <- terra::rast("data/data-abiotic/bathy_mean.tif")

# Bathymetry from GEBCO
## Let's mask this object with aoi before putting it back in stars
bathy <- terra::rast("data/data-abiotic/bathymetry.tif")
bathy <- terra::mask(bathy, terra::vect(aoi))
## Remove values of 0 and higher
bathy <- terra::clamp(bathy, upper = 0)
## Change negative depth to positive
bathy_neg <- bathy
bathy <- bathy*-1
```

The scale of **bathymetry.tif** seems to be finer than **bathy_mean.tif**:

```{r}
#| column: page
#| layout-ncol: 2
#| echo: FALSE
# Plot both
terra::plot(bathy_mean, main = "bathy_mean.tif");plot(aoi, add = TRUE, color = "transparent")
terra::plot(bathy, main = "bathymetry.tif");plot(aoi, add = TRUE, color = "transparent")
```

This is the differences between both datasets. Most of this difference must come from the different scale for both datasets.

```{r}
#| echo: FALSE
terra::plot(bathy - bathy_mean, main = "bathymetry - bathy_mean")
terra::plot(aoi, add = TRUE, color = "transparent")
```

```{r}
#| echo: FALSE
diff_bathy <- bathy - bathy_mean
dens_bathy_diff <- terra::density(terra::values(diff_bathy, na.rm = TRUE))
terra::plot(dens_bathy_diff)
```


Should we use other variables derived from bathymetry? As in Ross _et. al_ 2021 (https://www.frontiersin.org/articles/10.3389/fmars.2021.652540/full)

* slope

* TPI (Topographic Position Index): difference between the value of a cell and the mean value of its 8 surrounding cells

* TRI (Terrain Ruggedness Index): mean of the absolute differences between the value of a cell and the value of its 8 surrounding cells

* roughness: difference between the maximum and the minimum value of a cell and its 8 surrounding cells

```{r}
#| include: FALSE
charac <- terra::terrain(bathy_neg, c("slope", "TPI", "TRI", "roughness"), unit = "degrees")
```
```{r}
#| echo: FALSE
#| layout-ncol: 2
#| layout-nrow: 2
terra::plot(charac[[1]], main = "slope");plot(aoi, add = TRUE, color = "transparent")
terra::plot(charac[[2]], main = "TPI");plot(aoi, add = TRUE, color = "transparent")
terra::plot(charac[[3]], main = "TRI");plot(aoi, add = TRUE, color = "transparent")
terra::plot(charac[[4]], main = "roughness");plot(aoi, add = TRUE, color = "transparent")
```

TPI seems quite uniform over the entire area of study, so maybe it's not that relevant to use it.
Slope, TRI and roughness seems strongly correlated. Let's see:

```{r}
#| echo: FALSE
charac_df <- cbind(terra::values(bathy),
                   terra::values(charac[["slope"]]),
                   terra::values(charac[["TRI"]]),
                   terra::values(charac[["roughness"]]))
not_na_rows <- sapply(1:nrow(charac_df), function(x) all(!is.na(charac_df[x,])))
charac_df <- charac_df[not_na_rows,]
cor(charac_df)
```

Since everything is strongly correlated, we should only use one of these three variables.
Let's use slope since it's more intuitive to picture.

To summarize, for bathymetry and derivatives, we should use:

* the **bathymetry** from GEBCO since the scale is finer and

* the **slope**, since it's strongly correlated with TRI and roughness and it's more intuitive to picture. Slope is relevant to use since sea pens generally prefer flat area (https://www.frontiersin.org/articles/10.3389/fmars.2021.652540/full)


## Oxygen

* **oxygen_[2011-2020].tif** from DFO

* **sat.tif** from Beauchesne

* bio-oracle dissolved oxygen

EGSL data from DFO seems incomplete (**oxygen_[2011-2020].tif**):

```{r}
#| include: FALSE
# Oxygen data from EGSL
oxy <- terra::rast(sapply(2011:2020, function(x) {
  terra::rast(paste0("data/data-abiotic/oxygen_", x, ".tif"))
}))
```

```{r}
#| column: page
#| layout-ncol: 2
#| echo: FALSE
terra::plot(oxy[[1]], main = "oxygen_2011.tif")
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(oxy[[terra::nlyr(oxy)]], main = "oxygen_2020.tif")
terra::plot(aoi, add = TRUE, col = "transparent")
```

Oxygen saturation? From Beauchesne thesis, is it from Blais?

```{r}
#| echo: FALSE
sat <- terra::rast("data/data-abiotic/sat.tif")
terra::plot(sat, main = "sat.tif")
terra::plot(aoi, add = TRUE, col = "transparent")
```

Dissolved oxygen is also available from **bio-oracle**:

```{r}
#| include: FALSE
# There is also bio-oracle bottom dissoved oxygen
bio_oxy <- sdmpredictors::load_layers(c("BO22_dissoxmax_bdmean",
                                        "BO22_dissoxmean_bdmean",
                                        "BO22_dissoxmin_bdmean"))
bio_oxy <- terra::crop(bio_oxy, aoi) |>
  terra::mask(x = _, aoi)
```
```{r}
#| echo: FALSE
#| column: screen
#| layout-ncol: 3
terra::plot(bio_oxy[[1]],
            main = "max O2", 
            legend = FALSE,
            ylim = c(0, 420))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(bio_oxy[[2]], 
            main = "mean O2", 
            legend = FALSE,
            ylim = c(0, 420))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(bio_oxy[[3]], 
            main = "min O2",
            ylim = c(0, 420),
            legend.width = 2)
terra::plot(aoi, add = TRUE, col = "transparent")
```

To summarize, for oxygen, we should use either:

* **sat.tif**

* **mean dissolved oxygen** from bio-oracle

Let's note that Ross _et. al_ 2021 do not use oxygen at all because:

  * Average dissolved oxygen is inversely correlated with temperature-salinity interaction (-0.74)
  * Range of dissolved oxygen is correlated with mean carbon biomass of phytoplankton (0.74)

We should have a look at this with our data.



## Primary productivity

Since we're modelling sea pens, should we focus on bottom primary production? If so, then we have two datasets for now:

  - **present_benthic_mean_depth_primary_productivity_mean.tif** from Beauchesne

  - **bottom_primary_productivity.tif** from bio-oracle

```{r}
#| include: FALSE
pp1 <- terra::rast("data/data-abiotic/present_benthic_mean_depth_primary_productivity_mean.tif")
pp1[pp1<0] <- 0
pp2 <- terra::rast("data/data-abiotic/bottom_primary_productivity.tif")
pp2 <- terra::crop(pp2, aoi) |>
  terra::mask(x = _, aoi)
```

```{r}
#| echo: FALSE
#| column: page
#| layout-ncol: 2
terra::plot(pp1,
            main = "primary productivity beauchesne")
terra::plot(pp2, 
            main = "primary productivity biooracle")
```

Is it relevant to use if most of primary productivity seems to be near the coast and that sea pens are found mostly in deep water?



## Salinity

There is two datasets of bottom salinity:

  - **salinity_[2011-2020].tif** from DFO

  - **salmoymoy.tif** from Beauchesne, from Dutil 2011?

Salinity from Beauchesne seems very "uniform" compared to DFO data. But there is a part missing for **salinity_[2011-2020].tif** northeast of the area of study.

```{r}
#| include: FALSE
# EGSL salinity for 2011 to 2020
sal <- terra::rast(sapply(2011:2020, function(x) {
  terra::rast(paste0("data/data-abiotic/salinity_", x, ".tif"))
}))
# Mean for every years
sal <- terra::app(sal,mean)

# salmoymoy
salmoymoy <- terra::rast("data/data-abiotic/salmoymoy.tif")

```

```{r}
#| echo: FALSE
#| column: page
#| layout-ncol: 2
terra::plot(sal,
            main = "Mean salinity from DFO (2011-2020)",
            range = c(20, 35))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(salmoymoy, 
            main = "Salinity from Beauchesne (biooracle?)",
            range = c(20, 35))
terra::plot(aoi, add = TRUE, col = "transparent")
```

Let's see what bio-oracle salinity looks like (V2.2)

```{r}
#| include: FALSE

# Let's load bio-oracle data
biosal <- sdmpredictors::load_layers(c("BO22_salinitymax_bdmean",
                                       "BO22_salinitymean_bdmean",
                                       "BO22_salinitymin_bdmean"))
biosal <- terra::crop(biosal, aoi) |>
  terra::mask(x = _, aoi)
```

```{r}
#| echo: FALSE
#| column: screen
#| layout-ncol: 3
terra::plot(terra::rast(biosal[[1]]),
            main = "Max salinity at mean depth",
            range = c(20, 35))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(terra::rast(biosal[[2]]), 
            main = "Mean salinity at mean depth",
            range = c(20, 35))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(terra::rast(biosal[[3]]), 
            main = "Min salinity at mean depth",
            range = c(20, 35))
terra::plot(aoi, add = TRUE, col = "transparent")
```


With bio-oracle datasets, the area of study is entirely covered, which is not the case with **salinity_[2011-2020].tif** and **salmoymoy.tif**.
**salmoymoy.tif** seems quite similar to salinity data from **bio-oracle**.
Let's see:

```{r}
#| echo: FALSE
# Resample biosal[[3]] to the same gris as salmoymoy
biosal <- terra::rast(stars::st_warp(stars::st_as_stars(biosal[[2]]), dest = stars::read_stars("data/grid/grid.tif")))
terra::plot(biosal - salmoymoy)
terra::plot(aoi, add = TRUE, col = "transparent")
```
```{r}
#| echo: FALSE
plot(density(terra::values(biosal - salmoymoy, na.rm = TRUE)))
```

Since both datasets are very similar, we should use **bio-oracle** salinity data since it covers the entire study area.
Ross _et. al_ 2021 uses range of salinity since it captures the proximity to watermass boundaries and resulting physiological stress. We could look at range too.



## Temperature

We have two datasets:

  - **temperature_[2011-2020].tif** from DFO

  - **sbt.tif** from Beauchesne (I assume this is bottom temperature from Galbraith 2018?)

Again, there is a portion northeast of the area of study without any data for **temperature_[2011-2020].tif**.

```{r}
#| include: FALSE

# EGSL salinity for 2011 to 2020
temp <- terra::rast(sapply(2011:2020, function(x) {
  terra::rast(paste0("data/data-abiotic/temperature_", x, ".tif"))
}))
# Mean for every years
temp <- terra::app(temp,mean)

# sbt
sbt <- terra::rast("data/data-abiotic/sbt.tif")
```
```{r}
#| echo: FALSE
#| column: page
#| layout-ncol: 2
terra::plot(temp,
            main = "Mean temperature from DFO (2011-2020)")
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(sbt, 
            main = "Temperature from Beauchesne (from Galbraith 2018?)")
terra::plot(aoi, add = TRUE, col = "transparent")
```

The difference between both datasets seem minimal
```{r}
#| echo: FALSE
terra::plot(temp-sbt, main = "difference between both datasets")
terra::plot(aoi, add = TRUE, col = "transparent")
```


## Current velocity

Should we use current velocity since it can relate to anchoring ability of the sea pens (https://www.frontiersin.org/articles/10.3389/fmars.2021.652540/full).

Here are the min, mean and max current velocity at mean depth from bio-oracle.

I'm showing V2.1 because the minimum current velocity values in V2.2 are greater than mean current velocity, which seems odd.

```{r}
#| include: FALSE
# From bio-oracle
velocity <- sdmpredictors::load_layers(c("BO21_curvelmax_bdmean",
                                         "BO21_curvelmean_bdmean",
                                         "BO21_curvelmin_bdmean"))
velocity <- terra::crop(velocity, aoi) |>
  terra::mask(x = _, aoi)
```
```{r}
#| echo: FALSE
#| column: screen
#| layout-ncol: 3
terra::plot(terra::rast(velocity[[1]]),
            main = "max velocity at mean depth", 
            range = c(0, 0.5))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(terra::rast(velocity[[2]]), 
            main = "mean velocity at mean depth",
            range = c(0, 0.5))
terra::plot(aoi, add = TRUE, col = "transparent")
terra::plot(terra::rast(velocity[[3]]), 
            main = "min velocity at mean depth",
            range = c(0, 0.5))
terra::plot(aoi, add = TRUE, col = "transparent")
```
